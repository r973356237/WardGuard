# WardGuard 部署指南

## 项目概述
WardGuard 是一个科室管理系统，包含前端（React）和后端（Node.js + Express）两部分。

## 项目结构
```
WardGuard/
├── client/                 # 前端项目
│   ├── build/             # 前端构建产物（生产环境）
│   ├── src/               # 前端源码
│   └── package.json
├── express/               # 后端项目
│   ├── .env               # 当前环境配置
│   ├── .env.development   # 开发环境配置
│   ├── .env.production    # 生产环境配置
│   ├── config.js          # 配置管理模块
│   ├── index.js           # 后端入口文件
│   └── package.json
└── README.md
```

## 环境要求
- Node.js >= 16.0.0
- MySQL >= 5.7
- npm >= 8.0.0

## 本地开发环境部署

### 1. 安装依赖
```bash
# 安装后端依赖
cd express
npm install

# 安装前端依赖
cd ../client
npm install
```

### 2. 配置数据库
1. 创建MySQL数据库
2. 修改 `express/.env.development` 文件中的数据库配置

### 3. 启动开发环境
```bash
# 启动后端（开发模式）
cd express
npm run dev

# 启动前端（新终端）
cd client
npm start
```

## 生产环境部署（宝塔面板）

### 1. 服务器准备
- 安装宝塔面板
- 安装 Node.js 管理器
- 安装 MySQL 数据库
- 安装 Nginx

### 2. 数据库配置
1. 在宝塔面板中创建数据库
2. 修改 `express/.env.production` 文件：
```env
NODE_ENV=production
DB_HOST=localhost
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_NAME=your_db_name
DB_PORT=3306
JWT_SECRET=your_strong_jwt_secret
PORT=3000
LOG_LEVEL=error
CORS_ORIGIN=https://yourdomain.com
```

### 3. 上传项目文件
1. 将整个项目上传到服务器（如 `/www/wwwroot/wardguard/`）
2. 确保 `client/build/` 目录包含前端构建文件

### 4. 安装依赖
```bash
cd /www/wwwroot/wardguard/express
npm install --production
```

### 5. 配置 Node.js 应用（宝塔面板）
1. 打开宝塔面板 -> Node.js 项目
2. 添加 Node.js 项目：
   - 项目名称：WardGuard
   - 项目目录：`/www/wwwroot/wardguard/express`
   - 启动文件：`index.js`
   - 端口：3000
   - 运行环境：production

### 6. 配置 Nginx 反向代理
在宝塔面板中配置网站，Nginx 配置示例：
```nginx
server {
    listen 80;
    server_name yourdomain.com;
    
    # 静态文件直接由 Nginx 提供
    location / {
        root /www/wwwroot/wardguard/client/build;
        try_files $uri $uri/ @fallback;
    }
    
    # API 请求转发到 Node.js
    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 前端路由回退
    location @fallback {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 7. 启动应用
在宝塔面板的 Node.js 项目管理中启动 WardGuard 项目。

## 环境变量说明

### 开发环境 (.env.development)
- `NODE_ENV=development`：开发环境标识
- `LOG_LEVEL=debug`：详细日志输出
- `CORS_ORIGIN=*`：允许所有域名跨域

### 生产环境 (.env.production)
- `NODE_ENV=production`：生产环境标识
- `LOG_LEVEL=error`：只输出错误日志
- `CORS_ORIGIN=https://yourdomain.com`：限制跨域域名

## 常用命令

### 开发环境
```bash
# 启动开发环境后端
npm run dev

# 启动前端开发服务器
cd client && npm start
```

### 生产环境
```bash
# 构建前端
cd client && npm run build

# 启动生产环境后端
cd express && npm run prod
```

## 健康检查
访问 `http://yourdomain.com/api/health` 检查服务状态。

## 故障排除

### 1. 数据库连接失败
- 检查数据库配置是否正确
- 确认数据库服务是否启动
- 检查防火墙设置

### 2. 前端页面无法访问
- 确认前端已正确构建（`client/build/` 目录存在）
- 检查 Nginx 配置
- 查看 Node.js 应用日志

### 3. API 请求失败
- 检查 Node.js 应用是否正常运行
- 查看应用日志
- 确认端口配置正确

## 安全建议

1. **JWT密钥安全**
   - 如果您已有生产数据，可以继续使用当前的JWT_SECRET
   - 如果是全新部署，建议使用强密码作为JWT_SECRET
   - 定期更换JWT密钥（需要重新登录所有用户）

2. **数据库安全**
   - 如果您已有生产数据库，配置文件已自动使用您当前的数据库设置
   - 确保数据库密码足够强壮
   - 定期备份数据库

## 维护
- 定期查看应用日志
- 监控服务器资源使用情况
- 定期备份数据库和配置文件