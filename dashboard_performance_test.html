<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»ªè¡¨ç›˜APIæ€§èƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .info {
            background-color: #f0f9ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
        button {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #40a9ff;
        }
        button:disabled {
            background-color: #d9d9d9;
            cursor: not-allowed;
        }
        .timing {
            font-weight: bold;
            color: #722ed1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ä»ªè¡¨ç›˜APIæ€§èƒ½æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•æ–°çš„ä»ªè¡¨ç›˜ç»Ÿè®¡APIä¸åŸæœ‰å¤šä¸ªAPIè¯·æ±‚çš„æ€§èƒ½å¯¹æ¯”</p>
        
        <div class="test-section">
            <h3>1. ç™»å½•æµ‹è¯•</h3>
            <input type="text" id="username" placeholder="ç”¨æˆ·å" value="admin">
            <input type="password" id="password" placeholder="å¯†ç " value="admin123">
            <button onclick="testLogin()">ç™»å½•</button>
            <div id="loginResult"></div>
        </div>

        <div class="test-section">
            <h3>2. æ–°çš„ä»ªè¡¨ç›˜ç»Ÿè®¡APIæµ‹è¯•</h3>
            <button onclick="testNewDashboardAPI()" id="newApiBtn" disabled>æµ‹è¯•æ–°API (å•ä¸ªè¯·æ±‚)</button>
            <div id="newApiResult"></div>
        </div>

        <div class="test-section">
            <h3>3. åŸæœ‰å¤šä¸ªAPIè¯·æ±‚æµ‹è¯•</h3>
            <button onclick="testOldDashboardAPI()" id="oldApiBtn" disabled>æµ‹è¯•åŸæœ‰API (5ä¸ªè¯·æ±‚)</button>
            <div id="oldApiResult"></div>
        </div>

        <div class="test-section">
            <h3>4. æ€§èƒ½å¯¹æ¯”</h3>
            <button onclick="performanceComparison()" id="compareBtn" disabled>æ‰§è¡Œæ€§èƒ½å¯¹æ¯”æµ‹è¯•</button>
            <div id="comparisonResult"></div>
        </div>
    </div>

    <script>
        let authToken = '';
        const API_BASE = 'http://localhost:3000';

        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');
            
            try {
                const response = await fetch(`${API_BASE}/api/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success && data.data.token) {
                    authToken = data.data.token;
                    resultDiv.innerHTML = `<div class="result success">ç™»å½•æˆåŠŸï¼ç”¨æˆ·: ${data.data.user.name}</div>`;
                    
                    // å¯ç”¨å…¶ä»–æµ‹è¯•æŒ‰é’®
                    document.getElementById('newApiBtn').disabled = false;
                    document.getElementById('oldApiBtn').disabled = false;
                    document.getElementById('compareBtn').disabled = false;
                } else {
                    resultDiv.innerHTML = `<div class="result error">ç™»å½•å¤±è´¥: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">ç™»å½•é”™è¯¯: ${error.message}</div>`;
            }
        }

        async function testNewDashboardAPI() {
            const resultDiv = document.getElementById('newApiResult');
            resultDiv.innerHTML = '<div class="result info">æ­£åœ¨æµ‹è¯•æ–°çš„ä»ªè¡¨ç›˜API...</div>';
            
            const startTime = performance.now();
            
            try {
                const response = await fetch(`${API_BASE}/api/dashboard/stats`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <div>âœ… æ–°APIæµ‹è¯•æˆåŠŸï¼</div>
                            <div class="timing">â±ï¸ å“åº”æ—¶é—´: ${duration.toFixed(2)}ms</div>
                            <div>ğŸ“Š æ•°æ®: ${JSON.stringify(data.data, null, 2)}</div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="result error">æ–°APIæµ‹è¯•å¤±è´¥: ${data.message}</div>`;
                }
            } catch (error) {
                const endTime = performance.now();
                const duration = endTime - startTime;
                resultDiv.innerHTML = `<div class="result error">æ–°APIé”™è¯¯ (${duration.toFixed(2)}ms): ${error.message}</div>`;
            }
        }

        async function testOldDashboardAPI() {
            const resultDiv = document.getElementById('oldApiResult');
            resultDiv.innerHTML = '<div class="result info">æ­£åœ¨æµ‹è¯•åŸæœ‰å¤šä¸ªAPIè¯·æ±‚...</div>';
            
            const startTime = performance.now();
            
            try {
                const endpoints = [
                    '/api/users',
                    '/api/employees', 
                    '/api/medicines',
                    '/api/medical-examinations',
                    '/api/supplies'
                ];
                
                const requests = endpoints.map(endpoint => 
                    fetch(`${API_BASE}${endpoint}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    })
                );
                
                const responses = await Promise.all(requests);
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                const results = await Promise.all(responses.map(r => r.json()));
                
                const counts = {
                    users: results[0].success ? results[0].data.length : 0,
                    employees: results[1].success ? results[1].data.length : 0,
                    medicines: results[2].success ? results[2].data.length : 0,
                    examinations: results[3].success ? results[3].data.length : 0,
                    supplies: results[4].success ? results[4].data.length : 0
                };
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        <div>âœ… åŸæœ‰APIæµ‹è¯•æˆåŠŸï¼</div>
                        <div class="timing">â±ï¸ å“åº”æ—¶é—´: ${duration.toFixed(2)}ms</div>
                        <div>ğŸ“Š ç»Ÿè®¡: ç”¨æˆ·${counts.users}, å‘˜å·¥${counts.employees}, è¯å“${counts.medicines}, ä½“æ£€${counts.examinations}, ç‰©èµ„${counts.supplies}</div>
                    </div>
                `;
            } catch (error) {
                const endTime = performance.now();
                const duration = endTime - startTime;
                resultDiv.innerHTML = `<div class="result error">åŸæœ‰APIé”™è¯¯ (${duration.toFixed(2)}ms): ${error.message}</div>`;
            }
        }

        async function performanceComparison() {
            const resultDiv = document.getElementById('comparisonResult');
            resultDiv.innerHTML = '<div class="result info">æ­£åœ¨æ‰§è¡Œæ€§èƒ½å¯¹æ¯”æµ‹è¯•...</div>';
            
            const testRounds = 5;
            const newApiTimes = [];
            const oldApiTimes = [];
            
            // æµ‹è¯•æ–°API
            for (let i = 0; i < testRounds; i++) {
                const startTime = performance.now();
                try {
                    await fetch(`${API_BASE}/api/dashboard/stats`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    const endTime = performance.now();
                    newApiTimes.push(endTime - startTime);
                } catch (error) {
                    console.error('æ–°APIæµ‹è¯•å¤±è´¥:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 100)); // çŸ­æš‚å»¶è¿Ÿ
            }
            
            // æµ‹è¯•åŸæœ‰API
            for (let i = 0; i < testRounds; i++) {
                const startTime = performance.now();
                try {
                    const endpoints = ['/api/users', '/api/employees', '/api/medicines', '/api/medical-examinations', '/api/supplies'];
                    const requests = endpoints.map(endpoint => 
                        fetch(`${API_BASE}${endpoint}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            }
                        })
                    );
                    await Promise.all(requests);
                    const endTime = performance.now();
                    oldApiTimes.push(endTime - startTime);
                } catch (error) {
                    console.error('åŸæœ‰APIæµ‹è¯•å¤±è´¥:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 100)); // çŸ­æš‚å»¶è¿Ÿ
            }
            
            const newApiAvg = newApiTimes.reduce((a, b) => a + b, 0) / newApiTimes.length;
            const oldApiAvg = oldApiTimes.reduce((a, b) => a + b, 0) / oldApiTimes.length;
            const improvement = ((oldApiAvg - newApiAvg) / oldApiAvg * 100);
            
            resultDiv.innerHTML = `
                <div class="result success">
                    <h4>ğŸ“ˆ æ€§èƒ½å¯¹æ¯”ç»“æœ (${testRounds}è½®æµ‹è¯•)</h4>
                    <div><strong>æ–°APIå¹³å‡å“åº”æ—¶é—´:</strong> <span class="timing">${newApiAvg.toFixed(2)}ms</span></div>
                    <div><strong>åŸæœ‰APIå¹³å‡å“åº”æ—¶é—´:</strong> <span class="timing">${oldApiAvg.toFixed(2)}ms</span></div>
                    <div><strong>æ€§èƒ½æå‡:</strong> <span class="timing">${improvement.toFixed(1)}%</span></div>
                    <div><strong>æ—¶é—´èŠ‚çœ:</strong> <span class="timing">${(oldApiAvg - newApiAvg).toFixed(2)}ms</span></div>
                    <hr>
                    <div><strong>æ–°APIè¯¦ç»†æ—¶é—´:</strong> ${newApiTimes.map(t => t.toFixed(1)).join('ms, ')}ms</div>
                    <div><strong>åŸæœ‰APIè¯¦ç»†æ—¶é—´:</strong> ${oldApiTimes.map(t => t.toFixed(1)).join('ms, ')}ms</div>
                </div>
            `;
        }
    </script>
</body>
</html>